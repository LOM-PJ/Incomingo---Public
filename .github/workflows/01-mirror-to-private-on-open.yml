name: Mirror public issues to private (on open)

on:
  issues:
    types: [opened]

permissions:
  issues: write

env:
  PRIVATE_REPO: "LOM-PJ/LOM.Core"
  BOT_MARKER: "[SYNC BOT]"
  SYNC_LABEL: "sync:bot"

jobs:
  mirror:
    runs-on: ubuntu-latest

    steps:
      - name: Create private mirror issue (and copy initial labels)
        env:
          GH_TOKEN: ${{ secrets.ISSUESYNCTOKEN }}
          PUBLIC_REPO: ${{ github.repository }}
          PUBLIC_NUM: ${{ github.event.issue.number }}
        run: |
          set -euo pipefail

          public_json="$(curl -sS \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${PUBLIC_REPO}/issues/${PUBLIC_NUM}")"

          public_title="$(echo "$public_json" | jq -r '.title')"
          public_body="$(echo "$public_json" | jq -r '.body // ""')"
          public_url="$(echo "$public_json" | jq -r '.html_url')"

          sync_key="public#${PUBLIC_NUM}"

          # IMPORTANT: use -r so this becomes raw multi-line text, not a JSON string with quotes/\n
          private_body="$(jq -rn \
            --arg public_url "$public_url" \
            --arg sync_key "$sync_key" \
            --arg body "$public_body" \
            '[
              "Public issue: \($public_url)",
              "Sync-Key: \($sync_key)",
              "",
              "---",
              $body
            ] | join("\n")')"

          resp="$(curl -sS -X POST \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${PRIVATE_REPO}/issues" \
            -d "$(jq -n --arg title "$public_title" --arg body "$private_body" '{title:$title, body:$body}')" )"

          private_url="$(echo "$resp" | jq -r '.html_url')"
          private_num="$(echo "$resp" | jq -r '.number')"

          if [ -z "$private_url" ] || [ "$private_url" = "null" ] || [ -z "$private_num" ] || [ "$private_num" = "null" ]; then
            echo "Failed to create private issue. Response:"
            echo "$resp"
            exit 1
          fi

          echo "Created private issue: $private_url (#$private_num)"

          # Copy INITIAL labels (public -> private). Exclude sync labels.
          echo "$public_json" | jq -r '.labels[].name' | while IFS= read -r label_name; do
            [ -z "$label_name" ] && continue

            if [ "$label_name" = "${SYNC_LABEL}" ]; then
              continue
            fi
            case "$label_name" in
              sync:*) continue ;;
            esac

            label_encoded="$(jq -rn --arg s "$label_name" '$s|@uri')"

            status="$(curl -sS -o /dev/null -w "%{http_code}" \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${PRIVATE_REPO}/labels/${label_encoded}" || true)"

            if [ "$status" = "404" ]; then
              curl -sS -X POST \
                -H "Authorization: Bearer $GH_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/${PRIVATE_REPO}/labels" \
                -d "$(jq -n --arg name "$label_name" --arg color "cfd3d7" '{name:$name, color:$color}')" >/dev/null || true
            fi

            curl -sS -X POST \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${PRIVATE_REPO}/issues/${private_num}/labels" \
              -d "$(jq -n --arg l "$label_name" '{labels:[$l]}')" >/dev/null || true
          done

          comment_body="${BOT_MARKER} Created internal engineering issue: ${private_url}"
          curl -sS -X POST \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${PUBLIC_REPO}/issues/${PUBLIC_NUM}/comments" \
            -d "$(jq -n --arg body "$comment_body" '{body:$body}')"

          current_body="$(echo "$public_json" | jq -r '.body // ""')"
          if printf "%s" "$current_body" | grep -qE '^Private issue:\s*https://github\.com/'; then
            echo "Public issue already has mapping; skipping."
          else
            patched_body="$(printf "%s\n\nPrivate issue: %s\n" "$current_body" "$private_url")"
            curl -sS -X PATCH \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${PUBLIC_REPO}/issues/${PUBLIC_NUM}" \
              -d "$(jq -n --arg body "$patched_body" '{body:$body}')"
          fi

          # Best-effort sync label both sides
          curl -sS -X POST \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${PUBLIC_REPO}/issues/${PUBLIC_NUM}/labels" \
            -d "$(jq -n --arg l "${SYNC_LABEL}" '{labels:[$l]}')" >/dev/null || true

          curl -sS -X POST \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${PRIVATE_REPO}/issues/${private_num}/labels" \
            -d "$(jq -n --arg l "${SYNC_LABEL}" '{labels:[$l]}')" >/dev/null || true
