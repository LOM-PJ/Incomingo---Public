name: Sync public changes to private

on:
  issues:
    types: [edited, closed, reopened]
  issue_comment:
    types: [created]

permissions:
  issues: write

env:
  PRIVATE_REPO: LOM-PJ/LOM.Core
  BOT_MARKER: "[SYNC BOT]"

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Skip bot loopbacks
        if: |
          github.actor == 'github-actions[bot]' ||
          (github.event_name == 'issue_comment' && startsWith(github.event.comment.body, env.BOT_MARKER))
        run: echo "Skipping bot-originated event."

      - name: Sync to private
        if: |
          !(github.actor == 'github-actions[bot]' ||
          (github.event_name == 'issue_comment' && startsWith(github.event.comment.body, env.BOT_MARKER)))
        env:
          GH_TOKEN: ${{ secrets.ISSUESYNCTOKEN }}
          PUBLIC_REPO: ${{ github.repository }}
          PUBLIC_NUM: ${{ github.event.issue.number }}
          EVENT_NAME: ${{ github.event_name }}
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          set -euo pipefail

          # Fetch public issue to get mapping and current content
          public_json=$(curl -sS \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${PUBLIC_REPO}/issues/${PUBLIC_NUM}")

          public_title=$(echo "$public_json" | jq -r '.title')
          public_body=$(echo "$public_json" | jq -r '.body // ""')
          public_state=$(echo "$public_json" | jq -r '.state')
          public_url=$(echo "$public_json" | jq -r '.html_url')

          # Try to locate private issue from the "Private issue:" mapping line in the public body
          private_url=$(printf "%s" "$public_body" | sed -nE 's/^Private issue:\s*(https:\/\/github\.com\/[^ ]+\/issues\/[0-9]+).*$/\1/p' | head -n 1 || true)
          private_num=""
          if [ -n "$private_url" ]; then
            private_num=$(echo "$private_url" | awk -F/ '{print $7}')
          fi

          # Fallback: search private repo by Sync-Key if mapping not found
          if [ -z "$private_num" ]; then
            q=$(python3 - << 'PY'
import urllib.parse, os
public_num=os.environ["PUBLIC_NUM"]
repo=os.environ["PRIVATE_REPO"]
query=f'repo:{repo} in:body "Sync-Key: public#{public_num}"'
print(urllib.parse.quote(query))
PY
)
            search=$(curl -sS \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/search/issues?q=${q}")
            private_num=$(echo "$search" | jq -r '.items[0].number // empty')
          fi

          if [ -z "$private_num" ]; then
            echo "Could not locate private mirror issue for public #${PUBLIC_NUM}. Ensure mapping line exists."
            exit 0
          fi

          echo "Target private issue #${private_num}"

          if [ "$EVENT_NAME" = "issue_comment" ]; then
            # Mirror public comment to private (COMMENT_BODY may be multi-line; it's in env, not inlined into script)
            mirrored="${BOT_MARKER} Mirrored from public ${public_url}

${COMMENT_BODY}"

            curl -sS -X POST \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${PRIVATE_REPO}/issues/${private_num}/comments" \
              -d "$(jq -n --arg body "$mirrored" '{body:$body}')"

            exit 0
          fi

          # Issue edited/closed/reopened: keep private title/body/state aligned with public
          new_private_body=$(jq -n \
            --arg public_url "$public_url" \
            --arg sync_key "public#${PUBLIC_NUM}" \
            --arg body "$public_body" \
            '[
              "Public issue: \($public_url)",
              "Sync-Key: \($sync_key)",
              "",
              "---",
              $body
            ] | join("\n")')

          curl -sS -X PATCH \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${PRIVATE_REPO}/issues/${private_num}" \
            -d "$(jq -n --arg title "$public_title" --arg body "$new_private_body" '{title:$title, body:$body}')"

          state="open"
          if [ "$public_state" = "closed" ]; then state="closed"; fi

          curl -sS -X PATCH \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${PRIVATE_REPO}/issues/${private_num}" \
            -d "$(jq -n --arg state "$state" '{state:$state}')"
