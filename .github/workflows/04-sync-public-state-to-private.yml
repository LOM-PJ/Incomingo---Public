name: Sync public state to private

on:
  issues:
    types: [closed, reopened]

permissions:
  issues: write

env:
  PRIVATE_REPO: "LOM-PJ/LOM.Core"
  BOT_MARKER: "[SYNC BOT]"

jobs:
  sync_state:
    runs-on: ubuntu-latest

    steps:
      - name: Sync close/reopen to private mirror (with retry)
        env:
          GH_TOKEN: ${{ secrets.ISSUESYNCTOKEN }}
          PUBLIC_REPO: ${{ github.repository }}
          PUBLIC_NUM: ${{ github.event.issue.number }}
          ACTION: ${{ github.event.action }}   # closed | reopened
        run: |
          set -euo pipefail

          # Skip bot-originated events (e.g., if something else edited state)
          if [ "${{ github.actor }}" = "github-actions[bot]" ]; then
            echo "Skipping bot-originated event."
            exit 0
          fi

          target_state="open"
          if [ "$ACTION" = "closed" ]; then
            target_state="closed"
          fi

          echo "Public ${PUBLIC_REPO}#${PUBLIC_NUM} -> private state=${target_state}"

          private_num=""

          # Retry because close/reopen can happen quickly after creation, before mapping line exists
          for attempt in 1 2 3 4 5 6 7 8 9 10; do
            public_json="$(curl -sS \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${PUBLIC_REPO}/issues/${PUBLIC_NUM}")"

            public_body="$(echo "$public_json" | jq -r '.body // ""')"

            # Primary: mapping line
            private_url="$(printf "%s" "$public_body" | sed -nE 's/^Private issue:\s*(https:\/\/github\.com\/[^ ]+\/issues\/[0-9]+).*$/\1/p' | head -n 1 || true)"
            if [ -n "$private_url" ]; then
              private_num="$(echo "$private_url" | awk -F/ '{print $7}')"
            fi

            # Fallback: search by Sync-Key
            if [ -z "$private_num" ]; then
              q="$(jq -rn \
                --arg repo "$PRIVATE_REPO" \
                --arg num "$PUBLIC_NUM" \
                '("repo:" + $repo + " in:body \"Sync-Key: public#" + $num + "\"") | @uri')"

              search="$(curl -sS \
                -H "Authorization: Bearer $GH_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/search/issues?q=${q}")"

              private_num="$(echo "$search" | jq -r '.items[0].number // empty')"
            fi

            if [ -n "$private_num" ]; then
              echo "Found private mirror issue #$private_num on attempt $attempt"
              break
            fi

            echo "Private mirror not found yet (attempt $attempt); sleeping 2s..."
            sleep 2
          done

          if [ -z "$private_num" ]; then
            echo "No private mirror found for public #${PUBLIC_NUM}. Skipping state sync."
            exit 0
          fi

          # Patch private issue state
          curl -sS -X PATCH \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${PRIVATE_REPO}/issues/${private_num}" \
            -d "$(jq -n --arg state "$target_state" '{state:$state}')"
